import{R as x}from"./chunk-23AHP9H5.js";import{d as S,aP as M,r as u,a1 as O,$ as U,aQ as F,O as X,K as Y,c as C,o as B,n as A,k as j,p as q,a,t as z,N as L,ae as W,w as G,C as I}from"./chunk-WaRpenU8.js";/* empty css              */const K={onTextZone:{type:Function,default:void 0},appendTo:{type:null,default:"body"},disabled:{type:Boolean,default:!1},speechToText:{type:Function,default:void 0},submitToText:{type:Boolean,default:!1}},Q={submitText:e=>typeof e=="string",submit:e=>!0};async function H(e,n){const r=new FormData;r.append("file",n,"audio.wav");const c=await fetch(e,{method:"POST",body:r});if(!c.ok)throw new Error("Speech to text failed");return(await c.json()).text}const J=100,ee=S({name:"VkRecorderButton",components:{ElButton:M},props:K,emits:Q,setup(e,{emit:n}){const r=u(!1),c=u(!1),m=u(),g=O(),i=u("");let E=null;const d=new x({type:"wav",sampleRate:16e3,bitRate:16,onProcess:P}),V=()=>new Promise((o,t)=>{d.open(()=>{r.value=!0,x.WaveView&&(g.value=x.WaveView({elem:m.value})),o(!0)},(s,l)=>{F.error(`${l?"用户未授权, ":""}无法录音:${s}`),t(new Error(s))})}),Z=async()=>{await V(),r.value&&(d.start(),c.value=!0)},v=u(!1),R=u({x:0,y:0}),f=u(!1),p=u(!1);let w=!1;const N=()=>{const o=p.value;d.stop(async t=>{if(i.value=(window.URL||webkitURL).createObjectURL(t),d.close(),c.value=!1,n("submit",{blob:t,url:i.value}),o||e.submitToText)if(e.onTextZone)e.onTextZone({blob:t,url:i.value});else{if(e.speechToText){e.speechToText(t).then(s=>{n("submitText",s)});return}H("/speech-to-text",t).then(s=>{n("submitText",s)}).catch(s=>{console.error("语音识别错误:",s),F.error("转换文字失败")})}})},_=()=>{document.addEventListener("mousemove",D),document.addEventListener("mouseup",b)},k=()=>{document.removeEventListener("mousemove",D),document.removeEventListener("mouseup",b)},$=o=>{if(e.disabled)return;o.preventDefault(),w=!0;const t="touches"in o?o.touches[0]:o;R.value={x:t.clientX,y:t.clientY},o instanceof MouseEvent&&_(),E=setTimeout(()=>{w&&(v.value=!0,Z())},J)};function D(o){if(o.preventDefault(),!v.value)return;const t="touches"in o?o.touches[0]:o;R.value={x:t.clientX,y:t.clientY};const s=document.querySelector(".cancel-btn"),l=document.querySelector(".text-btn");if(s&&l){const T=s.getBoundingClientRect(),h=l.getBoundingClientRect();f.value=t.clientX>=T.left&&t.clientX<=T.right&&t.clientY>=T.top&&t.clientY<=T.bottom,p.value=t.clientX>=h.left&&t.clientX<=h.right&&t.clientY>=h.top&&t.clientY<=h.bottom}}function b(o){w=!1,clearTimeout(E),v.value&&(f.value?d.close():N(),v.value=!1,f.value=!1,p.value=!1),o instanceof MouseEvent&&k()}function P(o,t,s,l){g.value?.input(o[o.length-1],t,l)}return U(()=>{k()}),{onmousedown:$,onmousemove:D,onmouseup:b,recording:c,recordingNode:m,blobUrl:i,isDragging:v,cancelZone:f,isTextZone:p}}}),te={class:"vk-recorder-container"},oe={key:0,class:"vk-recording-mask"},ne={class:"recording-tip"},se={ref:"recordingNode",class:"wave-container"},ae={class:"tip-text"},ue={class:"action-buttons"};function ce(e,n,r,c,m,g){const i=Y("ElButton");return B(),C("div",te,[(B(),A(W,{to:e.appendTo},[e.isDragging?(B(),C("div",oe,[a("div",ne,[a("div",se,null,512),a("div",ae,z(e.cancelZone?"松开手指，取消发送":"松开发送，上滑取消"),1)]),a("div",ue,[a("div",{class:L(["cancel-btn",{active:e.cancelZone}])},n[0]||(n[0]=[a("div",{class:"btn-icon"}," × ",-1),a("div",{class:"btn-text"}," 取消发送 ",-1)]),2),a("div",{class:L(["text-btn",{active:e.isTextZone}])},n[1]||(n[1]=[a("div",{class:"btn-icon"}," 文 ",-1),a("div",{class:"btn-text"}," 转为文字 ",-1)]),2)])])):q("",!0)],8,["to"])),j(i,I(e.$attrs,{disabled:e.disabled,class:["vk-recorder-button",{"is-recording":e.recording}],size:"large",onTouchstart:e.onmousedown,onTouchmove:e.onmousemove,onTouchend:e.onmouseup,onMousedown:e.onmousedown}),{default:G(()=>n[2]||(n[2]=[a("span",{class:"vk-recorder-button-text"},"按住 说话",-1)])),_:1},16,["disabled","class","onTouchstart","onTouchmove","onTouchend","onMousedown"])])}const y=X(ee,[["render",ce]]);y.install=e=>{e.component(y.name||"VkRecorderButton",y)};export{y as V};
