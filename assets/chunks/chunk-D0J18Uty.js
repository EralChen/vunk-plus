import{M as H,V as J}from"./chunk-kXwQuj-U.js";import{d as w,c as $,o as y,F as V,k as m,a as Q,b as R,s as X,w as N,av as Y,m as p,R as q,aa as Z,I as A,a7 as D,at as ee,a1 as ae,M,p as L,U as te,r as U,a2 as T,aw as ne,O as re,K as S,D as se,n as B}from"./chunk-WaRpenU8.js";import{D as le}from"./chunk-CLfTKXP-.js";/* empty css              */const ue=H();function C(e){const u=ue.render(e);return new DOMParser().parseFromString(u,"text/html").body.textContent||""}var l=(e=>(e.initial="initial",e.processing="processing",e.pending="pending",e.fulfilled="fulfilled",e.rejected="rejected",e))(l||{}),r=(e=>(e.initial="initial",e.playing="playing",e.ended="ended",e.paused="paused",e.failed="failed",e))(r||{});const oe={data:{type:Array,default:void 0},source:{type:String,default:""},delay:{type:Number,default:0},separators:{type:Array,default:()=>[`

`,`
`]},pause:{type:Boolean,default:!1},keepRead:{type:Boolean,default:!1},webSpeech:{type:Boolean,default:!1},textToSpeech:{type:Function,default:void 0}},de={setData:e=>e,"update:broadcasting":e=>!0,"update:completed":e=>!0,"update:error":e=>!0},E=w({__name:"speech-error",setup(e){return(u,n)=>(y(),$(V,null,[m(R(X),{color:"var(--el-color-danger)",size:"1.5em",style:{verticalAlign:"text-bottom"}},{default:N(()=>[m(R(Y))]),_:1}),n[0]||(n[0]=Q("span",{style:{color:"var(--el-color-danger)"}}," 播报失败 ",-1))],64))}}),ie=w({components:{SpeechError:E},props:{data:{type:Object,default:()=>({})},deferred:{type:Object,required:!0},pause:{type:Boolean,default:!1},url:{type:String,default:""}},setup(e){const u=C(e.data.value).replace(/\n/g,""),n=p(()=>e.data);if(!u.trim())return e.deferred.resolve(!0),n.value.broadcast=r.ended,()=>null;const t=q();t.promise.then(d=>{d.addEventListener("playing",o),d.addEventListener("pause",f),d.addEventListener("error",h),d.addEventListener("ended",s)}),Z(()=>{t.value?.removeEventListener("playing",o),t.value?.removeEventListener("pause",f),t.value?.removeEventListener("error",h),t.value?.removeEventListener("ended",s)});function o(){n.value.broadcast=r.playing}function f(){n.value.broadcast=r.paused}function h(d){n.value.broadcast=r.failed,e.deferred.reject(d)}function s(){n.value.broadcast=r.ended,e.deferred.resolve(!0)}return A(()=>{D(()=>e.pause,d=>{e.data.status===l.pending&&(d?t.value?.pause():(n.value.broadcast===r.failed||n.value.broadcast===r.initial)&&t.promise.then(b=>{b.play().catch(c=>{n.value.broadcast=r.failed,e.deferred.reject(c)})}))},{immediate:!0})}),()=>m(V,null,[e.url&&m("audio",{src:e.url,ref:t.resolve},null),n.value.status===l.rejected&&m(E,null,null)])}}),ce=w({__name:"paragraph",props:{enable:{type:Boolean,default:!0},status:{type:String,default:l.initial},pause:{type:Boolean,default:!1},processing:{type:Function,default:ee}},emits:["update:status"],setup(e,{emit:u}){const n=e,t=u,o=ae(),f=q();A(async()=>{t("update:status",l.processing),await n.processing?.(),f.resolve()}),f.promise.catch(()=>{t("update:status",l.rejected)}),D(()=>n.enable,async s=>{s?h():o.value=void 0},{immediate:!0});async function h(){const s=new le;await f.promise,t("update:status",l.pending),s.promise.then(()=>{t("update:status",l.fulfilled)}).catch(d=>{console.error(d),t("update:status",l.rejected)}),o.value=void 0,te(()=>{o.value=s})}return(s,d)=>e.enable&&o.value?M(s.$slots,"default",{key:0,deferred:o.value}):L("",!0)}}),fe=w({components:{SpeechError:E},props:{voice:{type:null,required:!1},data:{type:Object,default:()=>({})},deferred:{type:Object,required:!0},pause:{type:Boolean,default:!1}},setup(e){const u=C(e.data.value).replace(/\n/g,""),n=p(()=>e.data);if(!u.trim())return e.deferred.resolve(!0),n.value.broadcast=r.ended,()=>null;const t=new SpeechSynthesisUtterance(u);return t.onend=function(){e.deferred.resolve(!0),n.value.broadcast=r.ended},t.onstart=function(){e.pause||(n.value.broadcast=r.playing)},t.onerror=function(o){e.deferred.reject(o),n.value.broadcast=r.failed,window.speechSynthesis.cancel()},e.voice&&(t.voice=e.voice),D(()=>e.pause,o=>{e.data.status===l.pending&&(o?(window.speechSynthesis.pause(),n.value.broadcast===r.playing&&(n.value.broadcast=r.paused)):(window.speechSynthesis.resume(),(n.value.broadcast===r.failed||n.value.broadcast===r.initial)&&(e.data.start===0&&window.speechSynthesis.cancel(),console.log("start speaking"),window.speechSynthesis.speak(t)),n.value.broadcast===r.paused&&(n.value.broadcast=r.playing)))},{immediate:!0}),()=>n.value.status===l.rejected&&m(E,null,null)}}),pe=w({name:"VkBroadcastingMarkdown",components:{ParagraphView:ce,VkTypingMarkdown:J,WebSpeechView:fe,CustomSpeechView:ie},props:oe,emits:de,setup(e,{emit:u}){const n=U([]),t=p(()=>e.data??n.value),o=a=>{if(e.data===void 0){ne(n.value,a);return}u("setData",a)},f=a=>{const i=t.value.length;o({k:i,v:a})},h=a=>{if(!e.textToSpeech)return;const i=C(a.value);return e.textToSpeech(`${i}`).then(g=>{a.url=g})},s=U(0),d=p(()=>s.value>=e.source.length),b=p(()=>e.source.substring(0,s.value)),c=p(()=>t.value.length===0?"......":t.value[0].broadcast===r.failed?"":t.value[0].broadcast===r.initial?"......":t.value.filter(a=>a.status===l.fulfilled||a.status===l.pending).map(a=>a.value).join("")),j=p(()=>[...e.separators].sort((a,i)=>a.length-i.length));D(d,a=>{!a&&v()},{immediate:!0});function v(){const a=t.value.at(-1);for(const i of j.value){const g=i.length;if(b.value.slice(s.value-g,s.value)===i){const k=a?.end??0,_=s.value,O=e.source.slice(k,_);if(a&&i.length>=O.length)a.status===l.initial&&(a.end=_,a.value=e.source.slice(a.start,_),a.separator=i);else{const G={start:k,separator:i,end:_,status:l.initial,value:O,broadcast:r.initial};f(G)}}}if(s.value<e.source.length)s.value++,setTimeout(v,e.delay);else{if(e.keepRead){setTimeout(v,e.delay);return}if(a?.end===s.value)return;const i=a?.end??0,g=s.value,x=e.source.slice(i,g);if(a&&a.status===l.initial&&a.separator==="")a.end=g,a.value=e.source.slice(a.start,g),a.separator="";else{const k={start:i,separator:"",end:g,status:l.initial,value:x,broadcast:r.initial};f(k)}}}const I=p(()=>t.value.some(a=>a.broadcast===r.playing));T(()=>{u("update:broadcasting",I.value)});const W=p(()=>e.keepRead===!1&&t.value.every(a=>a.status===l.fulfilled));T(()=>{u("update:completed",W.value)});const z=p(()=>t.value.some(a=>a.status===l.rejected));T(()=>{u("update:error",z.value)});function F(a){return t.value[a-1]?[l.fulfilled].includes(t.value[a-1].status):!0}function K(a){return F(a)}return{theData:t,ParagraphStatus:l,fulfilledTextValue:c,isPrevParagraphFulfilled:F,isParagraphEnabled:K,processingParagraph:h}}});function ve(e,u,n,t,o,f){const h=S("VkTypingMarkdown"),s=S("CustomSpeechView"),d=S("WebSpeechView"),b=S("ParagraphView");return y(),$(V,null,[M(e.$slots,"default",{paragraphs:e.theData},()=>[m(h,{source:e.fulfilledTextValue,delay:200,pause:e.pause},null,8,["source","pause"])]),(y(!0),$(V,null,se(e.theData,(c,j)=>(y(),B(b,{key:c.value,status:c.status,"onUpdate:status":v=>c.status=v,enable:e.isParagraphEnabled(j),processing:()=>e.processingParagraph(c)},{default:N(({deferred:v})=>[M(e.$slots,"paragraph",{data:c,deferred:v},()=>[c.url?(y(),B(s,{key:0,url:c.url,pause:e.pause,deferred:v,data:c},null,8,["url","pause","deferred","data"])):L("",!0),e.webSpeech?(y(),B(d,{key:1,pause:e.pause,deferred:v,data:c},null,8,["pause","deferred","data"])):L("",!0)])]),_:2},1032,["status","onUpdate:status","enable","processing"]))),128))],64)}const P=re(pe,[["render",ve]]);P.install=e=>{e.component(P.name||"VkBroadcastingMarkdown",P)};export{P as V};
