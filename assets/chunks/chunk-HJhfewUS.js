import{V as I}from"./chunk-DxePtwsq.js";import{_ as L,b as Q,c as q}from"./chunk-B_usEO8p.js";import{ba as g,b0 as T,bb as z,bc as _,d as x,r as A,b9 as M,o as V,A as P,B as S,F,b as f,h,e as j,ac as $,X as G,C as B,a8 as X,_ as W}from"./chunk-C-sTROv_.js";import{T as w}from"./chunk-CntOc3u2.js";/* empty css              */import"./chunk-CVh-Cx4v.js";import"./chunk-Db8R8jrI.js";/* empty css              */import"./chunk-DucCsfaH.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */const O="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAAAAADH8yjkAAADsElEQVRoBbXBsaoYBAwF0KTP0vBQgppBNGNn6VTu5Cj55ODoFDoV545RHKIuUlLqq/5EPIfp2cPzh2f0f/j09PHpEz97ePEonzHd+/efff/hiZ+/sG/t8YHuPb2f3+YDP37+8vuXXz2nex//fPfLu7/5iy9f/fDqmxd078Pvb39++xfr169/fP2d0L399c1Pb/5gNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGtavX//4+juhe/vrm5/e/MFffPnqh1ffvKB7H35/+/Pbv/jx85ffv/zqOd37+Oe7X979zc9f2Lf2+ED3nt7Pb/OBnz28eJTPmO79+8++//DE9Ozh+cMz+j98evr49Ok/l/tDxY3JIlEAAAAASUVORK5CYII=",K=80,H=4,b=5;async function Y(){const a=window.AudioContext||window.webkitAudioContext;if(!a)throw new Error("您的浏览器不支持Web Audio API");const t=new a;return t.state==="suspended"&&await t.resume(),t}class Z{constructor(){this.timings={},this.startTimes={}}start(t){this.startTimes[t]=performance.now()}end(t){const e=this.startTimes[t];if(e===void 0)return console.warn(`Timer "${t}" was not started`),0;const s=performance.now()-e;return this.timings[t]=s,delete this.startTimes[t],s}getTimings(){return{...this.timings}}reset(){this.timings={},this.startTimes={}}accumulate(t,e){this.timings[t]=(this.timings[t]||0)+e}merge(t){const e=t.getTimings();for(const[s,r]of Object.entries(e))this.accumulate(s,r)}}function J(a){return a instanceof Error?a.message:typeof a=="string"?a:"Unknown error occurred"}function tt(a,t="Operation failed"){return function(e){const s=J(e),r=`${a}: ${s}`;throw console.error(r),new Error(r)}}class et{constructor(){this.errorHandler=tt("FeatureExtractorService"),this.worker=g.path?new Worker(`${g.path}/feature.worker.js`,{type:"module"}):new Worker(new URL("/vunk-plus/assets/feature.worker-nwiwYQSI.js",import.meta.url),{type:"module"})}async process(t){try{const e=t.getChannelData(0),s=t.numberOfChannels>1?t.getChannelData(1):void 0,r={leftChannel:e,rightChannel:s,sampleRate:t.sampleRate},i=[e.buffer,s?.buffer].filter(Boolean);return await this.createWorkerPromise(r,i)}catch(e){throw this.errorHandler(e)}}createWorkerPromise(t,e){return new Promise((s,r)=>{const i=o=>{this.worker.removeEventListener("message",i),this.worker.removeEventListener("error",n),o.data.status==="success"?s(o.data.payload):r(new Error(o.data.error||"Unknown worker error"))};function n(o){this.worker.removeEventListener("message",i),this.worker.removeEventListener("error",n),r(o)}this.worker.addEventListener("message",i),this.worker.addEventListener("error",n),this.worker.postMessage(t,e)})}terminate(){this.worker.terminate()}}var R=Object.defineProperty,st=(a,t,e)=>t in a?R(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,U=(a,t)=>R(a,"name",{value:t,configurable:!0}),p=(a,t,e)=>st(a,typeof t!="symbol"?t+"":t,e),D=class{constructor(t){p(this,"promise"),p(this,"resolve"),p(this,"reject"),p(this,"queue"),p(this,"signal",null),p(this,"signalListener",null),this.queue=t,this.promise=new Promise((e,s)=>{this.resolve=e,this.reject=s})}setSignal(t){return t.aborted?this:(this.signal=t,this.signalListener=()=>{const e=this.queue.promises.indexOf(this);e!==-1&&this.queue.promises.splice(e,1),this.reject(new Error("Request aborted manually"))},this.signal.addEventListener("abort",this.signalListener),this)}use(){return this.dispose(),this.resolve(),this}abort(){return this.dispose(),this.reject(new Error("Request aborted manually")),this}dispose(){this.signal&&(this.signal.removeEventListener("abort",this.signalListener),this.signal=null,this.signalListener=null)}};U(D,"AsyncQueueEntry");var rt=D,N=class{constructor(){p(this,"promises",[])}get remaining(){return this.promises.length}get queued(){return this.remaining===0?0:this.remaining-1}wait(t){const e=new rt(this);return this.promises.length===0?(this.promises.push(e),Promise.resolve()):(this.promises.push(e),t?.signal&&e.setSignal(t.signal),e.promise)}shift(){if(this.promises.length!==0){if(this.promises.length===1){this.promises.shift();return}this.promises.shift(),this.promises[0].use()}}abortAll(){if(this.queued!==0){for(let t=1;t<this.promises.length;++t)this.promises[t].abort();this.promises.length=1}}};U(N,"AsyncQueue");var at=N;class it{constructor(){this.queue=new at,this.callbacks={},this.timer=new Z,this.chunkResults=[],this.totalChunks=0,this.completedChunks=0,this.totalFramesProcessed=0,this.isRunning=!1,this.audioBuffer=null,this.audioContext=null,this.featureExtractor=null}async createAudioBuffer(t,e,s){try{return new AudioBuffer({numberOfChannels:t,length:e,sampleRate:s})}catch{if(!this.audioContext){const r=window.AudioContext||window.webkitAudioContext;this.audioContext=new r}return this.audioContext.createBuffer(t,e,s)}}async processStreaming(t,e){if(await this.queue.wait(),this.isRunning)throw new Error("另一个音频正在处理中，请稍候。");this.isRunning=!0,this.audioBuffer=t,this.callbacks=e,this.chunkResults=[],this.completedChunks=0,this.totalFramesProcessed=0,this.featureExtractor=new et;const s=t.duration;this.totalChunks=Math.ceil(s/b);try{this.timer.start("totalProcessing");for(let r=0;r<this.totalChunks&&this.isRunning;r++)this.timer.start(`chunk_${r}`),await this.processChunk(r),this.timer.end(`chunk_${r}`);this.isRunning&&await this.finalize(),this.timer.end("totalProcessing")}catch(r){const i=r instanceof Error?r.message:"Unknown error";this.callbacks.onError?.(i)}finally{await this.queue.shift(),this.cleanup()}}async processChunk(t){if(!this.audioBuffer||!this.featureExtractor)return;const e=t*b,s=Math.min((t+1)*b,this.audioBuffer.duration),r=Math.floor(e*this.audioBuffer.sampleRate),i=Math.floor(s*this.audioBuffer.sampleRate),n=i-r;console.log(`处理chunk ${t}: ${e.toFixed(2)}s - ${s.toFixed(2)}s`);const o=await this.createAudioBuffer(this.audioBuffer.numberOfChannels,n,this.audioBuffer.sampleRate);for(let c=0;c<this.audioBuffer.numberOfChannels;c++){const m=this.audioBuffer.getChannelData(c);o.getChannelData(c).set(m.subarray(r,i))}try{this.timer.start(`extract_chunk_${t}`);const c=await this.featureExtractor.process(o);this.timer.end(`extract_chunk_${t}`);const m={chunkIndex:t,features:c.features,dimensions:c.dimensions,startTimeSeconds:e,endTimeSeconds:s};this.totalFramesProcessed+=m.dimensions[0],this.chunkResults[t]=m,this.completedChunks++,console.log(`Chunk ${t} 完成，特征维度: [${c.dimensions.join(", ")}]`),this.callbacks.onChunkComplete?.(m),this.callbacks.onProgress?.(this.completedChunks,this.totalChunks),this.chunkResults[t]=null}catch(c){throw console.error(`处理chunk ${t} 时发生错误:`,c),c}}async finalize(){if(console.log("最终确定所有chunk的处理..."),this.completedChunks===0){this.callbacks.onError?.("No chunks were processed.");return}const t=[this.totalFramesProcessed,H,K];console.log(`特征处理完成, 总维度: [${t.join(", ")}]`),this.callbacks.onComplete?.(t)}cleanup(){this.isRunning=!1,this.audioBuffer=null,this.featureExtractor&&(this.featureExtractor.terminate(),this.featureExtractor=null),this.chunkResults.forEach(t=>{t&&t.features&&(t.features=null)}),this.chunkResults=[],this.callbacks={},this.completedChunks=0,this.totalChunks=0,this.totalFramesProcessed=0,this.timer.reset()}stop(){this.isRunning&&(console.log("停止流式音频处理"),this.isRunning=!1,this.featureExtractor&&(this.featureExtractor.terminate(),this.featureExtractor=null),this.callbacks={},this.chunkResults=[],this.totalChunks=0,this.completedChunks=0,this.totalFramesProcessed=0)}}class nt{constructor(t,e){this.worker=null,this.callbacks={},this.isInitialized=!1,this.pendingChunks=new Map,this.completedChunks=new Set,this.totalFrames=0,this.isProcessing=!1,this.globalChunkIndex=0,this._def=new T,this.worker=g.path?new Worker(`${g.path}/streaming.inference.worker.js`,{type:"module"}):new Worker(new URL("/vunk-plus/assets/streaming.inference.worker-m6LPBqtF.js",import.meta.url),{type:"module"}),this.worker.onmessage=s=>{const{type:r}=s.data;switch(r){case"ready":this.isInitialized=!0,e?.(),this._def.resolve();break;case"progress":this.callbacks.onProgress?.(s.data.payload.processed,s.data.payload.total);break;case"frame":{const i=s.data.payload;this.callbacks.onFrame?.(i.frame,i.frameIndex);break}case"chunk_complete":{const i=s.data.payload;this.completedChunks.add(i.chunkIndex),this.callbacks.onChunkComplete?.(i.chunkIndex,i.timings),this.completedChunks.size===this.pendingChunks.size&&this.pendingChunks.size>0&&(this.callbacks.onAllComplete?.({}),this.lightCleanup());break}case"error":this.callbacks.onError?.(s.data.payload),this.cleanup();break}},this.worker.onerror=s=>{this.callbacks.onError?.(`Worker error: ${s.message}`),this.cleanup()},this.worker.postMessage({type:"init",modelPath:t})}isReady(){return this.isInitialized}when(){return this._def.promise}async startStreaming(t,e,s=0){if(!this.worker||!this.isInitialized)throw new Error("推理服务尚未初始化完成。");this.callbacks=e,this.pendingChunks.clear(),this.completedChunks.clear(),this.totalFrames=0,this.isProcessing=!0;const r=await t.zipBlob.arrayBuffer(),i={type:"init_streaming",dataset:t.dataset,zipBuffer:r,blendingMaskBitmap:t.blendingMaskBitmap,startImageIndex:s};this.worker.postMessage(i,[t.blendingMaskBitmap,r])}addChunk(t){if(!this.worker||!this.isProcessing){console.warn("无法添加chunk：推理服务未准备就绪或未在处理中");return}const e=t.dimensions[0],s=this.totalFrames,r=s+e;this.totalFrames=r;const i=this.globalChunkIndex++,n={chunkIndex:i,audioFeatures:t.features,audioDimensions:t.dimensions,startFrame:s,endFrame:r};this.pendingChunks.set(i,n);const o={type:"streaming_run",chunkData:n,dataset:{},zipBlob:new Blob,blendingMaskBitmap:{},startImageIndex:0};this.worker.postMessage(o,[n.audioFeatures.buffer])}finishAddingChunks(){this.worker&&this.worker.postMessage({type:"finish_chunks",totalFrames:this.totalFrames})}cleanup(){this.isProcessing=!1,this.callbacks={},this.pendingChunks.clear(),this.completedChunks.clear(),this.totalFrames=0,this.globalChunkIndex=0}lightCleanup(){this.completedChunks.clear(),this.pendingChunks.clear()}stop(){this.cleanup(),this.worker&&this.worker.postMessage({type:"stop"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null,this.isInitialized=!1),this.cleanup()}}async function ot(a="/complete_dataset.json",t="/processed_images.zip"){const[e,s]=await Promise.all([fetch(a),fetch(t)]);if(!e.ok)throw new Error("无法加载图像元数据 `complete_dataset.json`。");if(!s.ok)throw new Error("无法加载图像压缩包 `processed_images.zip`。");const r=await e.json(),i=await s.blob(),n=await z.loadAsync(i);return{imageData:r,zip:n,zipBlob:i}}async function ut(a){const t=await Y(),e=await a.arrayBuffer();return t.decodeAudioData(e)}async function ct(a,t){return new Promise((e,s)=>{new it().processStreaming(a,{onChunkComplete:t?.onChunkComplete,onComplete:i=>{e(i)},onError:i=>{s(new Error(i))}})})}async function lt(a){const{imageData:t,zip:e,zipBlob:s}=await ot(a.datasetUrl,a.sourceUrl),r=new Image;r.src=O,await r.decode();const i=await createImageBitmap(r);return{dataset:t,zip:e,zipBlob:s,blendingMaskBitmap:i}}async function ht(a){return _({method:"POST",contentType:"application/json",url:`/application/${a.application_id}/text_to_speech`,data:{text:a.text,type:"ai-chat"},responseThen(t){return t.blob()}})}async function mt(a){return _({method:"POST",url:"/application/authentication",data:{access_token:a.access_token}}).then(t=>t.data)}const pt={source:{type:String,default:""},textToSpeech:{type:Function,required:!0},modelUrl:{type:String,required:!0},datasetUrl:{type:String,required:!0},sourceUrl:{type:String,required:!0},status:{type:String,default:void 0},playAfterCache:{type:Number,default:100}},dt={"update:status":null},C=x({name:"VkMetahumanBroadcasting",inheritAttrs:!1,__name:"index",props:pt,emits:dt,setup(a,{emit:t}){const e=a,s=t,r=A([]),i=new nt(e.modelUrl),n=A([]),o=M({default:w.pending,key:"status"},e,s);V(async()=>{await i.when();const{blendingMaskBitmap:l,dataset:u,zipBlob:d}=await lt({datasetUrl:e.datasetUrl,sourceUrl:e.sourceUrl});await i.startStreaming({blendingMaskBitmap:l,dataset:u,zipBlob:d},{onFrame(k){n.value.push(k)},onProgress(k,v){(v<e.playAfterCache&&k===v||k===e.playAfterCache)&&(o.value=w.play)}})});async function c(l){await i.when();try{await ct(l,{onChunkComplete(u){i.addChunk(u)}})}catch(u){console.error("音频处理错误:",u)}}async function m(l){if(l.blob)try{const u=await ut(l.blob);await c(u)}catch(u){console.error("Error processing paragraph:",u)}}function E(l){l&&r.value.length&&(o.value=w.stop,n.value.length=0)}return(l,u)=>(S(),P(F,null,[f(h(I),j(l.$attrs,{status:h(o),data:r.value,"text-to-speech":l.textToSpeech,source:l.source,processing:m,onSetData:u[0]||(u[0]=d=>h($)(r.value,d)),"onUpdate:completed":E}),null,16,["status","data","text-to-speech","source"]),f(h(L),{status:h(o),"onUpdate:status":u[1]||(u[1]=d=>G(o)?o.value=d:null),data:n.value},null,8,["status","data"])],64))}});C.install=a=>{a.component(C.name||"VkMetahumanBroadcasting",C)};let y=null;async function ft(a){return y||(y=mt({access_token:"21c0f2a5067fb1cb"}).then(t=>{localStorage.setItem("accessToken",t),sessionStorage.setItem("accessToken",t)})),await y,ht({application_id:"2c0946f4-02f0-11f0-b881-0242ac170002",text:a}).then(t=>t)}const gt={"h-450px":""},kt=`大自然里，草长莺飞，莺歌燕舞，她生活在一个美好的世界里。

然而，当她经过茧里的痛苦与挣扎，终于破茧而出时，却不是一只在空中轻盈飞舞的花蝴蝶，而是蜕变成为了一只灰色的小飞蛾。

在同伴的叹息中，她笑着流下了激动的泪水。`,ae=x({__name:"basic",setup(a){g.path="/vunk-plus/sophontalk";const t="/vunk-plus/sophontalk/model.onnx",e="/vunk-plus/sophontalk/processed_images.zip",s="/vunk-plus/sophontalk/complete_dataset.json",r=A(w.paused);return(i,n)=>(S(),P(F,null,[B("p",null,"当前状态: "+X(r.value),1),f(h(q),null,{default:W(()=>[f(h(C),{status:r.value,"onUpdate:status":n[0]||(n[0]=o=>r.value=o),"model-url":t,"source-url":e,"dataset-url":s,source:kt,"text-to-speech":h(ft)},null,8,["status","text-to-speech"]),B("div",gt,[f(h(Q),{"default-options":{background:"#FFF"}})])]),_:1})],64))}});export{ae as default};
