import{av as m,az as C,aA as b}from"./chunk-D9MUhhqC.js";const A="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAAAAADH8yjkAAADsElEQVRoBbXBsaoYBAwF0KTP0vBQgppBNGNn6VTu5Cj55ODoFDoV545RHKIuUlLqq/5EPIfp2cPzh2f0f/j09PHpEz97ePEonzHd+/efff/hiZ+/sG/t8YHuPb2f3+YDP37+8vuXXz2nex//fPfLu7/5iy9f/fDqmxd078Pvb39++xfr169/fP2d0L399c1Pb/5gNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGlZDwIXubVfWsBoCLnRvu7KG1RBwoXvblTWshoAL3duurGE1BFzo3nZlDash4EL3titrWA0BF7q3XVnDagi40L3tyhpWQ8CF7m1X1rAaAi50b7uyhtUQcKF725U1rIaAC93brqxhNQRc6N52ZQ2rIeBC97Yra1gNARe6t11Zw2oIuNC97coaVkPAhe5tV9awGgIudG+7sobVEHChe9uVNayGgAvd266sYTUEXOjedmUNqyHgQve2K2tYDQEXurddWcNqCLjQve3KGtavX//4+juhe/vrm5/e/MFffPnqh1ffvKB7H35/+/Pbv/jx85ffv/zqOd37+Oe7X979zc9f2Lf2+ED3nt7Pb/OBnz28eJTPmO79+8++//DE9Ozh+cMz+j98evr49Ok/l/tDxY3JIlEAAAAASUVORK5CYII=";var p=Object.defineProperty,y=(a,e,s)=>e in a?p(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s,k=(a,e)=>p(a,"name",{value:e,configurable:!0}),u=(a,e,s)=>y(a,typeof e!="symbol"?e+"":e,s),g=class{constructor(e){u(this,"promise"),u(this,"resolve"),u(this,"reject"),u(this,"queue"),u(this,"signal",null),u(this,"signalListener",null),this.queue=e,this.promise=new Promise((s,t)=>{this.resolve=s,this.reject=t})}setSignal(e){return e.aborted?this:(this.signal=e,this.signalListener=()=>{const s=this.queue.promises.indexOf(this);s!==-1&&this.queue.promises.splice(s,1),this.reject(new Error("Request aborted manually"))},this.signal.addEventListener("abort",this.signalListener),this)}use(){return this.dispose(),this.resolve(),this}abort(){return this.dispose(),this.reject(new Error("Request aborted manually")),this}dispose(){this.signal&&(this.signal.removeEventListener("abort",this.signalListener),this.signal=null,this.signalListener=null)}};k(g,"AsyncQueueEntry");var E=g,w=class{constructor(){u(this,"promises",[])}get remaining(){return this.promises.length}get queued(){return this.remaining===0?0:this.remaining-1}wait(e){const s=new E(this);return this.promises.length===0?(this.promises.push(s),Promise.resolve()):(this.promises.push(s),e?.signal&&s.setSignal(e.signal),s.promise)}shift(){if(this.promises.length!==0){if(this.promises.length===1){this.promises.shift();return}this.promises.shift(),this.promises[0].use()}}abortAll(){if(this.queued!==0){for(let e=1;e<this.promises.length;++e)this.promises[e].abort();this.promises.length=1}}};k(w,"AsyncQueue");var B=w;const v=80,R=4,f=5;async function I(){const a=window.AudioContext||window.webkitAudioContext;if(!a)throw new Error("您的浏览器不支持Web Audio API");const e=new a;return e.state==="suspended"&&await e.resume(),e}class D{constructor(){this.queue=new B,this.callbacks={},this.chunkResults=[],this.totalChunks=0,this.completedChunks=0,this.totalFramesProcessed=0,this.isRunning=!1,this.audioBuffer=null,this.audioContext=null,this.worker=null}async createAudioBuffer(e,s,t){try{return new AudioBuffer({numberOfChannels:e,length:s,sampleRate:t})}catch{if(!this.audioContext){const i=window.AudioContext||window.webkitAudioContext;this.audioContext=new i}return this.audioContext.createBuffer(e,s,t)}}async processWithWorker(e){if(!this.worker)throw new Error("Worker not initialized");return new Promise((s,t)=>{const i=()=>{this.worker&&(this.worker.removeEventListener("message",r),this.worker.removeEventListener("error",n))};function r(h){i(),h.data.status==="success"?s(h.data.payload):t(new Error(h.data.error||"Unknown worker error"))}function n(h){i(),t(h)}this.worker.addEventListener("message",r),this.worker.addEventListener("error",n);const o=e.getChannelData(0),c=e.numberOfChannels>1?e.getChannelData(1):void 0,d={leftChannel:o,rightChannel:c,sampleRate:e.sampleRate},l=[o.buffer,c?.buffer].filter(Boolean);this.worker.postMessage(d,l)})}async processStreaming(e,s){if(await this.queue.wait(),this.isRunning)throw new Error("另一个音频正在处理中，请稍候。");this.isRunning=!0,this.audioBuffer=e,this.callbacks=s,this.chunkResults=[],this.completedChunks=0,this.totalFramesProcessed=0,this.worker||(this.worker=new Worker(`${m.path}/feature.worker.js`,{type:"module"}));const t=e.duration;this.totalChunks=Math.ceil(t/f);try{for(let i=0;i<this.totalChunks&&this.isRunning;i++)await this.processChunk(i);this.isRunning&&await this.finalize()}catch(i){const r=i instanceof Error?i.message:"Unknown error";this.callbacks.onError?.(r)}finally{await this.queue.shift(),this.cleanup()}}async processChunk(e){if(!this.audioBuffer||!this.worker)return;const s=e*f,t=Math.min((e+1)*f,this.audioBuffer.duration),i=Math.floor(s*this.audioBuffer.sampleRate),r=Math.floor(t*this.audioBuffer.sampleRate),n=r-i,o=await this.createAudioBuffer(this.audioBuffer.numberOfChannels,n,this.audioBuffer.sampleRate);for(let l=0;l<this.audioBuffer.numberOfChannels;l++){const h=this.audioBuffer.getChannelData(l);o.getChannelData(l).set(h.subarray(i,r))}const c=await this.processWithWorker(o),d={chunkIndex:e,features:c.features,dimensions:c.dimensions,startTimeSeconds:s,endTimeSeconds:t};this.totalFramesProcessed+=d.dimensions[0],this.chunkResults[e]=d,this.completedChunks++,this.callbacks.onChunkComplete?.(d),this.callbacks.onProgress?.(this.completedChunks,this.totalChunks),this.chunkResults[e]=null}async finalize(){if(this.completedChunks===0){this.callbacks.onError?.("No chunks were processed.");return}const e=[this.totalFramesProcessed,R,v];this.callbacks.onComplete?.(e)}cleanup(){this.isRunning=!1,this.audioBuffer=null,this.worker&&(this.worker.terminate(),this.worker=null),this.chunkResults.forEach(e=>{e&&e.features&&(e.features=null)}),this.chunkResults=[],this.callbacks={},this.completedChunks=0,this.totalChunks=0,this.totalFramesProcessed=0}stop(){this.isRunning&&(this.isRunning=!1,this.worker&&(this.worker.terminate(),this.worker=null),this.callbacks={},this.chunkResults=[],this.totalChunks=0,this.completedChunks=0,this.totalFramesProcessed=0)}}class z{constructor(e,s){this.worker=null,this.callbacks={},this.isInitialized=!1,this.pendingChunks=new Map,this.completedChunks=new Set,this.totalFrames=0,this.isProcessing=!1,this.globalChunkIndex=0,this._def=new C,this.worker=new Worker(`${m.path}/streaming.inference.worker.js`,{type:"module"}),this.worker.onmessage=t=>{const{type:i}=t.data;switch(i){case"ready":this.isInitialized=!0,s?.(),this._def.resolve();break;case"progress":this.callbacks.onProgress?.(t.data.payload.processed,t.data.payload.total);break;case"frame":{const r=t.data.payload;this.callbacks.onFrame?.(r.frame,r.frameIndex);break}case"chunk_complete":{const r=t.data.payload;this.completedChunks.add(r.chunkIndex),this.callbacks.onChunkComplete?.(r.chunkIndex,r.timings),this.completedChunks.size===this.pendingChunks.size&&this.pendingChunks.size>0&&(this.callbacks.onAllComplete?.({}),this.lightCleanup());break}case"error":this.callbacks.onError?.(t.data.payload),this.cleanup();break}},this.worker.onerror=t=>{this.callbacks.onError?.(`Worker error: ${t.message}`),this.cleanup()},this.worker.postMessage({type:"init",modelPath:e})}isReady(){return this.isInitialized}when(){return this._def.promise}async startStreaming(e,s,t=0){if(!this.worker||!this.isInitialized)throw new Error("推理服务尚未初始化完成。");this.callbacks=s,this.pendingChunks.clear(),this.completedChunks.clear(),this.totalFrames=0,this.isProcessing=!0;const i=await e.zipBlob.arrayBuffer(),r={type:"init_streaming",dataset:e.dataset,zipBuffer:i,blendingMaskBitmap:e.blendingMaskBitmap,startImageIndex:t};this.worker.postMessage(r,[e.blendingMaskBitmap,i])}addChunk(e){if(!this.worker||!this.isProcessing){console.warn("无法添加chunk：推理服务未准备就绪或未在处理中");return}const s=e.dimensions[0],t=this.totalFrames,i=t+s;this.totalFrames=i;const r=this.globalChunkIndex++,n={chunkIndex:r,audioFeatures:e.features,audioDimensions:e.dimensions,startFrame:t,endFrame:i};this.pendingChunks.set(r,n);const o={type:"streaming_run",chunkData:n,dataset:{},zipBlob:new Blob,blendingMaskBitmap:{},startImageIndex:0};this.worker.postMessage(o,[n.audioFeatures.buffer])}finishAddingChunks(){this.worker&&this.worker.postMessage({type:"finish_chunks",totalFrames:this.totalFrames})}cleanup(){this.isProcessing=!1,this.callbacks={},this.pendingChunks.clear(),this.completedChunks.clear(),this.totalFrames=0,this.globalChunkIndex=0}lightCleanup(){this.completedChunks.clear(),this.pendingChunks.clear()}stop(){this.cleanup(),this.worker&&this.worker.postMessage({type:"stop"})}terminate(){this.worker&&(this.worker.terminate(),this.worker=null,this.isInitialized=!1),this.cleanup()}}async function N(a="/complete_dataset.json",e="/processed_images.zip"){const[s,t]=await Promise.all([fetch(a),fetch(e)]);if(!s.ok)throw new Error("无法加载图像元数据 `complete_dataset.json`。");if(!t.ok)throw new Error("无法加载图像压缩包 `processed_images.zip`。");const i=await s.json(),r=await t.blob(),n=await b.loadAsync(r);return{imageData:i,zip:n,zipBlob:r}}async function q(a){const e=await I(),s=await a.arrayBuffer();return e.decodeAudioData(s)}async function x(a,e){return new Promise((s,t)=>{new D().processStreaming(a,{onChunkComplete:e?.onChunkComplete,onComplete:r=>{s(r)},onError:r=>{t(new Error(r))}})})}async function _(a){const{imageData:e,zip:s,zipBlob:t}=await N(a.datasetUrl,a.sourceUrl),i=new Image;i.src=A,await i.decode();const r=await createImageBitmap(i);return{dataset:e,zip:s,zipBlob:t,blendingMaskBitmap:r}}export{z as S,q as b,_ as g,x as p};
